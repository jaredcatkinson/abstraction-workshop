<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.59.1" />
    <meta name="description" content="Abstraction Workshop">
<meta name="author" content="SpecterOps">

    <link rel="shortcut icon" href="/abstraction-workshop/images/favicon.png" type="image/x-icon" />

    <title>Engineer a Detection - Procmon :: Abstraction Workshop</title>

    
    <link href="/abstraction-workshop/css/nucleus.css" rel="stylesheet">
    <link href="/abstraction-workshop/css/fontawesome-all.min.css" rel="stylesheet">
    <link href="/abstraction-workshop/css/hybrid.css" rel="stylesheet">
    <link href="/abstraction-workshop/css/featherlight.min.css" rel="stylesheet">
    <link href="/abstraction-workshop/css/perfect-scrollbar.min.css" rel="stylesheet">
    <link href="/abstraction-workshop/css/auto-complete.css" rel="stylesheet">
    <link href="/abstraction-workshop/css/atom-one-dark-reasonable.css" rel="stylesheet">
    <link href="/abstraction-workshop/css/theme.css" rel="stylesheet">
    <link href="/abstraction-workshop/css/hugo-theme.css" rel="stylesheet">
    
      <link href="/abstraction-workshop/css/theme-specterops.css" rel="stylesheet">
    

    <script src="/abstraction-workshop/js/jquery-3.3.1.min.js"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    
  </head>
  <body class="" data-url="/abstraction-workshop/labs/eng_procmon/">
    <nav id="sidebar" class="showVisitedLinks">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="/abstraction-workshop">
    <font color="white"><i class='fas fa-home'></i> Workshop</font>
</a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="/abstraction-workshop/js/lunr.min.js"></script>
<script type="text/javascript" src="/abstraction-workshop/js/auto-complete.js"></script>
<script type="text/javascript">
    
        var baseurl = "\/abstraction-workshop";
    
</script>
<script type="text/javascript" src="/abstraction-workshop/js/search.js"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          


 
  
    
    <li data-nav-id="/abstraction-workshop/labs/" title="Labs" class="dd-item 
        parent
        
        
        ">
      <a href="/abstraction-workshop/labs/">
          <i class='fas fa-flask'></i> Labs
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/abstraction-workshop/labs/eng_api_monitor/" title="Engineer a Detection - API Monitor" class="dd-item ">
        <a href="/abstraction-workshop/labs/eng_api_monitor/">
        <i class='fab fa-leanpub'></i> Engineer a Detection - API Monitor
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/abstraction-workshop/labs/eng_rpc_etw/" title="Engineer a Detection - Logman ETW" class="dd-item ">
        <a href="/abstraction-workshop/labs/eng_rpc_etw/">
        <i class='fab fa-leanpub'></i> Engineer a Detection - Logman ETW
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/abstraction-workshop/labs/eng_procmon/" title="Engineer a Detection - Procmon" class="dd-item active">
        <a href="/abstraction-workshop/labs/eng_procmon/">
        <i class='fab fa-leanpub'></i> Engineer a Detection - Procmon
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
         
    </ul>

    
    
      <section id="shortcuts">
        <h3>More</h3>
        <ul>
          
              <li> 
                  <a class="padding" href="/abstraction-workshop/"><i class='fas fa-home'></i> Home</a>
              </li>
          
              <li> 
                  <a class="padding" href="https://specterops.io"><i class='fas fa-ghost'></i> Specterops</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="prefooter">
      <hr/>
      <ul>
      
      
      
        <li><a class="padding" href="#" data-clear-history-toggle=""><i class="fas fa-history fa-fw"></i> Clear History</a></li>
      
      </ul>
    </section>
    
    <section id="footer">
      
    </section>
  </div>
</nav>





        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            <a href='/abstraction-workshop/'></a> > <a href='/abstraction-workshop/labs/'>Labs</a> > Engineer a Detection - Procmon
          
         
          
         
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#description">Description</a></li>
<li><a href="#goals">Goals</a>
<ul>
<li><a href="#by-the-end-of-this-lab-you-should-be-able-to">By the end of this lab, you should be able to</a></li>
</ul></li>
<li><a href="#requirements">Requirements</a></li>
<li><a href="#steps">Steps</a></li>
<li><a href="#1-open-procmon">1. Open Procmon:</a></li>
<li><a href="#2-set-up-procmon-for-dynamic-analysis">2. Set up Procmon for dynamic analysis</a></li>
<li><a href="#2-run-example-using-procmon">2. Run example using Procmon</a></li>
<li><a href="#3-analyze-results">3. Analyze results</a></li>
<li><a href="#4-change-capture-filter">4. Change Capture Filter</a></li>
<li><a href="#questions">Questions:</a></li>
</ul></li>
</ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              Engineer a Detection - Procmon
            </h1>
          

        





<h2 id="description">Description</h2>

<p>Now that we have selected New Service as our technique, and used the detection guidance within MITRE ATT&amp;CK to research common utilities. We have chosen to focus on PowerShell&rsquo;s New-Service cmdlet as one of the most common methods to install services. In this next step, we will monitor SC.EXE with Procmon to dynamically analyze how it creates a service, and continue filling out the abstraction map.</p>


<div class="notices tip" ><p>Review previous labs for process similarities in order to accomplish the main objective(s)</p>
</div>


<h2 id="goals">Goals</h2>

<h3 id="by-the-end-of-this-lab-you-should-be-able-to">By the end of this lab, you should be able to</h3>

<ul>
<li>Understand how to use Procmon</li>
<li>Understand how to perform dynamic analysis with Procmon</li>
</ul>


<div class="notices warning" ><p>If this is not the case, please ask for help!</p>
</div>


<h2 id="requirements">Requirements</h2>

<ul>
<li>Access to the Windows 10 student system</li>
<li>Sysinterals Procmon</li>
</ul>


<section class="attachments blue">
	<label>
		<i class="fas fa-paperclip" aria-hidden="true"></i>
		Lab files
	</label>
	
		
	
	<div class="attachments-files">
	
		
	

	<p>None</p>
	

	<div>
		
	
</section>



<hr />

<h2 id="steps">Steps</h2>

<h2 id="1-open-procmon">1. Open Procmon:</h2>

<ul>
<li>Open File Explorer and navigate to <code>C:\tools\SysinteralsSuite</code></li>
</ul>

<p><img src="images/procmon_9.png?width=50pc" alt="Procmon" /></p>

<ul>
<li>Right click on <code>Procmon64.exe</code> and click &ldquo;Run as administrator&rdquo;</li>
<li>Click on &ldquo;Agree&rdquo; on the License Agreement</li>
</ul>

<p>Procmon should be open and ready to use:</p>

<p><img src="images/procmon_10.png?width=50pc" alt="Procmon" /></p>

<h2 id="2-set-up-procmon-for-dynamic-analysis">2. Set up Procmon for dynamic analysis</h2>

<p>Now that we have an example of a common method to install a service, we are going to use Procmon to dynamically analyze what happens when the <code>New-Service</code> powershell cmdlet creates a service.</p>

<p>Follow the steps below to set Procmon up:</p>

<ul>
<li>With Procmon open, click on Filter</li>
</ul>

<p><img src="images/procmon_1.png?width=50pc" alt="Procmon 1" /></p>

<ul>
<li>Click on Filter again</li>
</ul>

<p><img src="images/procmon_2.png?width=50pc" alt="Procmon 1" /></p>

<ul>
<li>In the Filter popup, enter the following values as: <code>Process Name is powershell.exe</code>. See screenshot for reference. Once these values are added, click <code>Add</code></li>
</ul>

<p><img src="images/procmon_3.png?width=50pc" alt="Procmon 1" /></p>

<ul>
<li>Once the filter appears in the list, click Apply</li>
</ul>

<p><img src="images/procmon_4.png?width=50pc" alt="Procmon 1" /></p>

<p>Procmon is now configured to show us events for only <code>powershell.exe</code> activity on our system</p>

<h2 id="2-run-example-using-procmon">2. Run example using Procmon</h2>

<p>Now that Procmon is configured, we need to install a service using <code>powershell.exe</code></p>

<p>To do this:</p>

<ul>
<li>Open an Administrative PowerShell window</li>
<li>Run the following command:</li>
</ul>

<p><code>New-Service -Name LabService -BinaryPathName C:\Windows\System32\notepad.exe</code></p>

<p><img src="images/procmon_6.png?width=50pc" alt="Procmon 1" /></p>

<p>If the command completed successfully, you will see</p>

<p><img src="images/procmon_7.png?width=50pc" alt="Procmon 1" /></p>

<h2 id="3-analyze-results">3. Analyze results</h2>

<p>Now that our service has been created, we need to see what clues are contained in the Procmon data.</p>

<p><img src="images/procmon_8.png?width=50pc" alt="Procmon 1" /></p>

<p>We can see in Procmon that there is an amount of activity, but reading through, we see no evidence of interaction with <code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services</code>. Why is this?</p>

<p>We know that the Service Control Manager database is stored in the registry. Is powershell.exe the process creating the service? No. However, we don&rsquo;t know which process is so lets do some more analysis to find out.</p>

<h2 id="4-change-capture-filter">4. Change Capture Filter</h2>

<ul>
<li>With Procmon open, click on Filter</li>
</ul>

<p><img src="images/procmon_1.png?width=50pc" alt="Procmon 1" /></p>

<ul>
<li><p>Click on Filter again</p></li>

<li><p>In the Filter popup, enter the following values as: <code>Path begins with HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\</code>. Then click <code>Add</code></p></li>
</ul>

<p><img src="images/registrykey.png" alt="Procmon" /></p>

<ul>
<li>We want to remove powershell.exe from the capture list, to do this uncheck its box on the left of its column within the filter listing. Your filter should now look like this:</li>
</ul>

<p><img src="images/filter.png" alt="Procmon" /></p>

<ul>
<li><p>Once the filter is removed click <code>Apply</code></p></li>

<li><p>Go back over to Procmon and perform analysis</p></li>
</ul>

<p><img src="images/result.png" alt="procmon" /></p>

<h2 id="questions">Questions:</h2>

<ul>
<li>What is the process name that created the service?</li>
<li>Why is this process used? Does it relate to RPC? If so - how?</li>
<li>How is powershell calling this process to create this service?</li>
<li>What is the full path name of the registry key?</li>
</ul>


<footer class=" footline" >
	
</footer>


        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
        
        


	 
	 
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/abstraction-workshop/js/clipboard.min.js"></script>
    <script src="/abstraction-workshop/js/perfect-scrollbar.min.js"></script>
    <script src="/abstraction-workshop/js/perfect-scrollbar.jquery.min.js"></script>
    <script src="/abstraction-workshop/js/jquery.sticky.js"></script>
    <script src="/abstraction-workshop/js/featherlight.min.js"></script>
    <script src="/abstraction-workshop/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/abstraction-workshop/js/modernizr.custom-3.6.0.js"></script>
    <script src="/abstraction-workshop/js/learn.js"></script>
    <script src="/abstraction-workshop/js/hugo-learn.js"></script>

    <link href="/abstraction-workshop/mermaid/mermaid.css" rel="stylesheet" />
    <script src="/abstraction-workshop/mermaid/mermaid.js"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    <script src="/abstraction-workshop/js/extra.js"></script>

  </body>
</html>

